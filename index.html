<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anik Financial Pro Reporting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        .pro-card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .input-field { width: 100%; border: 1.5px solid #e2e8f0; padding: 10px; border-radius: 12px; font-size: 14px; outline: none; background: #fdfdfd; }
        .input-field:focus { border-color: #0046ad; background: #fff; }
        .section-title { background: #0046ad; color: white; padding: 8px 15px; border-radius: 10px; font-size: 11px; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; margin-top: 25px; }
        .table-input { width: 100%; border-bottom: 2px solid #cbd5e1; text-align: center; font-weight: bold; font-size: 13px; }
        #loader { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body class="pb-10">

    <!-- FAST LOADER -->
    <div id="loader">
        <img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" class="h-14 animate-pulse">
        <p class="text-[10px] font-bold text-gray-400 mt-4 uppercase tracking-widest italic">System Loading...</p>
    </div>

    <div class="max-w-xl mx-auto p-4">
        <!-- LOGO -->
        <div class="text-center my-6">
            <img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" class="h-14 mx-auto">
        </div>

        <!-- SELECTION -->
        <div id="selection-card" class="pro-card p-6 space-y-4 border border-gray-100">
            <div>
                <label class="text-[10px] font-bold text-gray-400 ml-1">युनिट निवडा</label>
                <select id="unitSelect" onchange="filterNames()" class="input-field mt-1"></select>
            </div>
            <div id="nameDiv" class="hidden">
                <label class="text-[10px] font-bold text-gray-400 ml-1">नांव निवडा</label>
                <select id="nameSelect" onchange="startForm()" class="input-field mt-1"></select>
            </div>
        </div>

        <!-- MAIN FORM -->
        <form id="reportingForm" class="hidden mt-6 pb-20">
            <div class="pro-card p-6 space-y-4">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 id="roleTitle" class="font-black text-blue-900 italic uppercase"></h2>
                    <input type="date" name="Report_Date" id="currentDate" class="text-xs font-bold border-none outline-none">
                </div>

                <div id="dynamicSections"></div>

                <button type="submit" id="submitBtn" class="w-full bg-[#0046ad] text-white font-bold py-4 rounded-2xl shadow-xl mt-8 uppercase tracking-widest text-sm hover:scale-[1.02] active:scale-95 transition">
                    Submit Final Report
                </button>
            </div>
        </form>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwFLk31KvO94CEnO1m28C1nUSReyigqGpKF_JbCZnO1xjSQMnQGc4gvkbK2IDRzZNQ/exec';
        let fullData = {};
        let user = {};

        window.onload = async () => {
            const res = await fetch(scriptURL);
            fullData = await res.json();
            const units = [...new Set(fullData.staff.map(s => s[3]))];
            document.getElementById('unitSelect').innerHTML = '<option value="">-- निवडा --</option>' + units.map(u => `<option value="${u}">${u}</option>`).join('');
            document.getElementById('loader').style.display = 'none';
        };

        function filterNames() {
            const unit = document.getElementById('unitSelect').value;
            const filtered = fullData.staff.filter(s => s[3] === unit);
            document.getElementById('nameSelect').innerHTML = '<option value="">-- निवडा --</option>' + filtered.map(s => `<option value="${s[0]}">${s[1]} (${s[2]})</option>`).join('');
            document.getElementById('nameDiv').classList.remove('hidden');
        }

        function startForm() {
            const id = document.getElementById('nameSelect').value;
            user = fullData.staff.find(s => s[0] == id);
            document.getElementById('roleTitle').innerText = `${user[2]} REPORT`;
            document.getElementById('currentDate').valueAsDate = new Date();
            renderForm(user[2]);
            document.getElementById('reportingForm').classList.remove('hidden');
        }

        function renderForm(role) {
            const container = document.getElementById('dynamicSections');
            const caList = user[5] ? user[5].split(',') : []; // CA List from Column F

            if(role === 'FX') {
                container.innerHTML = `
                    <div class="section-title">आजचे एकुण कलेक्शन (Regular + OD)</div>
                    <table class="w-full text-[11px] mb-4">
                        <tr class="text-gray-400"><td>सी ऐ नांव</td><td>खाते</td><td>रक्कम</td></tr>
                        ${caList.map(ca => `
                            <tr><td class="font-bold py-3 border-b">${ca}</td>
                            <td class="border-b"><input type="number" name="RegOD_Qty_${ca}" class="table-input fx-qty" oninput="calcFX()"></td>
                            <td class="border-b"><input type="number" name="RegOD_Amt_${ca}" class="table-input fx-amt" oninput="calcFX()"></td></tr>
                        `).join('')}
                        <tr class="font-black text-blue-800"><td>एकूण</td><td id="total-qty" class="text-center italic">0</td><td id="total-amt" class="text-center italic">0</td></tr>
                    </table>

                    <div class="section-title">कॅश / डिजीटल फोड (सी ऐ निहाय)</div>
                    ${caList.map(ca => `
                        <div class="grid grid-cols-3 gap-2 mb-2 items-center">
                            <span class="text-[10px] font-bold">${ca}</span>
                            <input type="number" name="Cash_${ca}" placeholder="कॅश" class="input-field text-xs">
                            <input type="number" name="Digital_${ca}" placeholder="डिजीटल" class="input-field text-xs">
                        </div>
                    `).join('')}

                    <div class="section-title">हातावर शिल्लक (Discipline)</div>
                    ${caList.map(ca => `
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <span class="text-[10px] font-bold">${ca}</span>
                            <input type="number" name="HandCash_${ca}" placeholder="शिल्लक रक्कम" class="input-field text-xs">
                        </div>
                    `).join('')}
                    <textarea name="Cash_Reason" placeholder="शिल्लक राहण्याचे कारण लिहा..." class="input-field mt-2 h-16"></textarea>

                    <div class="section-title">Portfolio & Interactions</div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[9px] font-bold">Visited</label><input type="number" name="Visited" class="input-field"></div>
                        <div><label class="text-[9px] font-bold">Not Paid</label><input type="number" name="NotPaid" class="input-field"></div>
                    </div>

                    <div class="section-title">आजची ओडी स्थिती & टार्गेट</div>
                    <table class="w-full text-[11px]">
                        ${caList.map(ca => `
                            <tr><td class="font-bold py-3 border-b">${ca}</td>
                            <td class="border-b"><input type="number" name="OD_Qty_${ca}" placeholder="OD खाते" class="table-input"></td>
                            <td class="border-b"><input type="number" name="OD_Amt_${ca}" placeholder="OD रक्कम" class="table-input"></td></tr>
                        `).join('')}
                    </table>
                    <label class="text-[9px] font-bold mt-4 block">ओडी कधीपर्यंत कमी करणार? तारीख निवडा</label>
                    <input type="date" name="OD_Reduction_Date" class="input-field">
                    <textarea name="Complaints" placeholder="तक्रारी व समस्या..." class="input-field mt-4 h-16"></textarea>
                `;
            } else if(role === 'BM') {
                container.innerHTML = `
                    <div class="section-title">शाखेचे एकूण कलेक्शन</div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" name="Total_Cust" placeholder="एकूण ग्राहक" class="input-field">
                        <input type="number" name="Total_Amt" placeholder="रक्कम" class="input-field">
                        <input type="number" name="Cash_Total" placeholder="कॅश एकूण" class="input-field">
                        <input type="number" name="Digi_Total" placeholder="डिजीटल एकूण" class="input-field">
                    </div>

                    <div class="section-title">ओडी बकेट्स (1-30, 31-90, 91+)</div>
                    <div class="space-y-3">
                        <div class="flex gap-2"><span class="w-20 text-[10px] font-bold">1-30 Days</span><input type="number" name="P1_Q" placeholder="Qty" class="input-field"><input type="number" name="P1_A" placeholder="Amt" class="input-field"></div>
                        <div class="flex gap-2"><span class="w-20 text-[10px] font-bold">31-90 Days</span><input type="number" name="P2_Q" placeholder="Qty" class="input-field"><input type="number" name="P2_A" placeholder="Amt" class="input-field"></div>
                        <div class="flex gap-2"><span class="w-20 text-[10px] font-bold">91+ Days</span><input type="number" name="P3_Q" placeholder="Qty" class="input-field"><input type="number" name="P3_A" placeholder="Amt" class="input-field"></div>
                    </div>

                    <div class="section-title">वाटप (Disbursement)</div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" name="Disb_Qty" placeholder="ग्राहक संख्या" class="input-field">
                        <input type="number" name="Disb_Amt" placeholder="रक्कम" class="input-field">
                    </div>
                    <select name="Digital_Connect" class="input-field mt-2"><option value="">सर्व डिजीटल कनेक्शन केले काय?</option><option value="Yes">Yes</option><option value="No">No</option></select>
                    <textarea name="Actions" placeholder="आजच्या प्रमुख ॲक्शन..." class="input-field mt-4 h-16"></textarea>
                `;
            } else if(role === 'CA') {
                container.innerHTML = `
                    <div class="section-title">रेग्युलर कलेक्शन</div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" name="Reg_Qty" placeholder="ग्राहक" class="input-field">
                        <input type="number" name="Reg_Amt" placeholder="रक्कम" class="input-field">
                    </div>
                    <div class="section-title">ओडी कलेक्शन</div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" name="OD_Qty" placeholder="ग्राहक" class="input-field">
                        <input type="number" name="OD_Amt" placeholder="रक्कम" class="input-field">
                    </div>
                    <div class="section-title">फील्ड वर्क & ॲक्टिव्हिटी</div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" name="Meetings" placeholder="गट बैठका" class="input-field">
                        <input type="number" name="NewGroups" placeholder="नवीन गट" class="input-field">
                        <input type="number" name="Forms" placeholder="फॉर्म भरले" class="input-field">
                        <input type="number" name="Digital" placeholder="डिजीटल जोडले" class="input-field">
                    </div>
                    <textarea name="Problems" placeholder="आजच्या कामातील अडचणी..." class="input-field mt-4 h-16"></textarea>
                `;
            }
        }

        function calcFX() {
            let q = 0, a = 0;
            document.querySelectorAll('.fx-qty').forEach(i => q += Number(i.value) || 0);
            document.querySelectorAll('.fx-amt').forEach(i => a += Number(i.value) || 0);
            document.getElementById('total-qty').innerText = q;
            document.getElementById('total-amt').innerText = a;
        }

        document.getElementById('reportingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerText = "Syncing with Anik Server...";
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.Role = user[2];
            data.StaffName = user[1];
            data.Unit = user[3];

            await fetch(scriptURL, { method: 'POST', body: JSON.stringify(data) });
            alert("Data Submitted Successfully!");
            location.reload();
        });
    </script>
</body>
</html>
