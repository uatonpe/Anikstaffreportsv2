<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anik Financial Reporting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .pro-input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; background: #f8fafc; font-size: 14px; outline: none; transition: all 0.2s; }
        .pro-input:focus { border-color: #2563eb; background: #fff; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        .loader-spin { border: 3px solid #f3f3f3; border-top: 3px solid #2563eb; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6 border border-gray-100">
        <!-- LOGO -->
        <div class="flex justify-center mb-8">
            <img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" alt="Anik Logo" class="h-14">
        </div>

        <!-- INITIAL LOADER -->
        <div id="app-loader" class="flex flex-col items-center py-10">
            <div class="loader-spin"></div>
            <p class="text-xs text-gray-500 mt-4 font-bold uppercase tracking-widest">Loading System...</p>
        </div>

        <!-- SELECTION STEPS -->
        <div id="app-content" class="hidden space-y-6">
            
            <!-- STEP 1: SELECT UNIT -->
            <div id="step-unit">
                <label class="text-[10px] font-extrabold text-gray-400 uppercase ml-1">आपले युनिट निवडा</label>
                <select id="unitSelect" onchange="filterNames()" class="pro-input mt-1">
                    <option value="">-- निवडा --</option>
                </select>
            </div>

            <!-- STEP 2: SELECT NAME -->
            <div id="step-name" class="hidden">
                <label class="text-[10px] font-extrabold text-gray-400 uppercase ml-1">आपले नांव निवडा</label>
                <select id="nameSelect" onchange="loadStaffForm()" class="pro-input mt-1">
                    <option value="">-- निवडा --</option>
                </select>
            </div>

            <!-- DYNAMIC FORM -->
            <form id="reportingForm" class="hidden pt-4 border-t border-gray-100 space-y-4">
                <div id="formFields" class="grid grid-cols-1 gap-4">
                    <!-- Fields injected here -->
                </div>
                
                <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-blue-700 transition transform active:scale-95 uppercase tracking-wider text-sm">
                    Submit Report
                </button>
            </form>
        </div>

        <!-- SUCCESS MESSAGE -->
        <div id="successPage" class="hidden text-center py-10">
            <div class="text-5xl mb-4">✅</div>
            <h2 class="text-xl font-bold text-gray-800">डेटा यशस्वीरित्या जतन झाला!</h2>
            <button onclick="location.reload()" class="mt-6 text-blue-600 font-bold underline">नवीन एन्ट्री करा</button>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwlwWJzthAbflBGHqnNfgXgWvrrgqiG4ESvYRanTSIkUM7SZus81q5o2_lSFlTN8Lk/exec';
        let fullData = {};
        let selectedStaff = {};

        // १. सिस्टिम स्टार्टअप - डेटा फास्ट फेच करणे
        async function loadApp() {
            try {
                const res = await fetch(scriptURL);
                fullData = await res.json();
                
                const units = [...new Set(fullData.staff.map(s => s[3]))]; // Column D
                const unitSelect = document.getElementById('unitSelect');
                units.forEach(u => unitSelect.innerHTML += `<option value="${u}">${u}</option>`);
                
                document.getElementById('app-loader').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
            } catch (err) { alert("सिस्टिम लोड एरर!"); }
        }

        // २. युनिटनुसार नावे फिल्टर करणे
        function filterNames() {
            const unit = document.getElementById('unitSelect').value;
            const nameSelect = document.getElementById('nameSelect');
            nameSelect.innerHTML = '<option value="">-- निवडा --</option>';
            
            if(unit) {
                const filtered = fullData.staff.filter(s => s[3] === unit);
                filtered.forEach(s => nameSelect.innerHTML += `<option value="${s[0]}">${s[1]} (${s[2]})</option>`);
                document.getElementById('step-name').classList.remove('hidden');
            } else {
                document.getElementById('step-name').classList.add('hidden');
            }
        }

        // ३. नावानुसार फॉर्म लोड करणे (FX, CA, BM)
        function loadStaffForm() {
            const staffId = document.getElementById('nameSelect').value;
            selectedStaff = fullData.staff.find(s => s[0] == staffId);
            const role = selectedStaff[2]; // Role: FX/CA/BM
            
            const formFields = document.getElementById('formFields');
            const reportingForm = document.getElementById('reportingForm');
            formFields.innerHTML = '';
            
            const headers = fullData.headers[role];

            headers.forEach(header => {
                const div = document.createElement('div');
                const labelText = header.replace(/_/g, ' ');
                
                // AUTO-FILL LOGIC: Staff ID, Name, CA Name, Branch इ. आपोआप भरणे
                let val = "";
                if(header === "Staff_ID") val = selectedStaff[0];
                if(header === "FX_Name" || header === "Staff_Name") val = selectedStaff[1];
                if(header === "Role") val = selectedStaff[2];
                if(header === "Branch_Name" || header === "Unit_Name") val = selectedStaff[3];
                if(header === "Reporting_CA_ID" || header === "Reporting_CA_Name") val = selectedStaff[4]; // FX साठी CA निहाय माहिती

                let type = "text";
                if(header.toLowerCase().includes('date')) type = "date";
                if(header.toLowerCase().includes('amount') || header.toLowerCase().includes('count')) type = "number";

                div.innerHTML = `
                    <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">${labelText}</label>
                    <input type="${type}" name="${header}" value="${val}" ${val ? 'readonly class="pro-input bg-gray-100"' : 'class="pro-input"'} placeholder="${labelText}">
                `;
                formFields.appendChild(div);
            });

            reportingForm.classList.remove('hidden');
        }

        // ४. फॉर्म सबमिट करणे
        document.getElementById('reportingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerText = "Saving to Server...";

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.Role = selectedStaff[2]; // Script ला सांगण्यासाठी

            await fetch(scriptURL, { method: 'POST', body: JSON.stringify(data) });
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('successPage').classList.remove('hidden');
        });

        window.onload = loadApp;
    </script>
</body>
</html>
